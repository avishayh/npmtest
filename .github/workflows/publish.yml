name: Publish Package

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Distribution tag (alpha, beta, latest)'
        required: false
        default: 'alpha'
      version_bump:
        description: 'Version bump type (prerelease, patch, minor, major)'
        required: false
        default: 'prerelease'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/publish.yml'
  # Allow manual trigger for act testing
  workflow_call:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC/provenance
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for versioning
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://evidencetrial.jfrog.io/artifactory/api/npm/evidence-dev-npm/'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Configure npm for JFrog Artifactory
        run: |
          echo "Configuring npm for JFrog Artifactory..."
          # Try to get token from secret or environment variable
          TOKEN="${{ secrets.NPM_TOKEN }}"
          if [ -z "$TOKEN" ] && [ -n "$NPM_TOKEN" ]; then
            TOKEN="$NPM_TOKEN"
            echo "Using NPM_TOKEN from environment variable"
          elif [ -z "$TOKEN" ]; then
            echo "ERROR: NPM_TOKEN is not set in secrets or environment!"
            exit 1
          else
            echo "Using NPM_TOKEN from secrets"
          fi
          echo "Token length: ${#TOKEN} chars"
          # Find where npm looks for config (setup-node might set NPM_CONFIG_USERCONFIG)
          NPMRC_LOC="${NPM_CONFIG_USERCONFIG:-$HOME/.npmrc}"
          echo "Using .npmrc at: $NPMRC_LOC"
          # JFrog Artifactory uses _auth format, not _authToken
          echo "registry=https://evidencetrial.jfrog.io/artifactory/api/npm/evidence-dev-npm/" > "$NPMRC_LOC"
          echo "always-auth=true" >> "$NPMRC_LOC"
          echo "//evidencetrial.jfrog.io/artifactory/api/npm/evidence-dev-npm/:_auth=$TOKEN" >> "$NPMRC_LOC"
          echo "npmrc configured successfully at $NPMRC_LOC"
          echo "Verifying .npmrc contents (redacted):"
          cat "$NPMRC_LOC" | sed 's/\(_auth=\).*/\1***REDACTED***/'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Bump version
        id: version
        run: |
          VERSION_BUMP="${{ inputs.version_bump || 'prerelease' }}"
          if [ "$VERSION_BUMP" == "prerelease" ]; then
            npm version prerelease --preid=alpha --no-git-tag-version
          elif [ "$VERSION_BUMP" == "patch" ]; then
            npm version patch --no-git-tag-version
          elif [ "$VERSION_BUMP" == "minor" ]; then
            npm version minor --no-git-tag-version
          elif [ "$VERSION_BUMP" == "major" ]; then
            npm version major --no-git-tag-version
          fi
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      
      - name: Display version
        run: |
          echo "Publishing version: ${{ steps.version.outputs.version || 'unknown' }}"
      
      - name: Debug - Show package.json
        run: |
          echo "=== DEBUG: Current package.json ==="
          cat package.json
          echo ""
          echo "=== DEBUG: Package version ==="
          node -p "require('./package.json').version"
          echo ""
          echo "=== DEBUG: Package name ==="
          node -p "require('./package.json').name"
      
      - name: Debug - Show npm configuration
        run: |
          echo "=== DEBUG: npm configuration ==="
          npm config list
          echo ""
          echo "=== DEBUG: npm registry ==="
          npm config get registry
          echo ""
          echo "=== DEBUG: npm cache location ==="
          npm config get cache
          echo ""
          echo "=== DEBUG: npm tmp location ==="
          npm config get tmp
          echo ""
          echo "=== DEBUG: NPM_CONFIG_USERCONFIG ==="
          echo "$NPM_CONFIG_USERCONFIG"
          echo ""
          echo "=== DEBUG: .npmrc contents (redacted) ==="
          if [ -f "$NPM_CONFIG_USERCONFIG" ]; then
            cat "$NPM_CONFIG_USERCONFIG" | sed 's/\(_auth=\).*/\1***REDACTED***/'
          elif [ -f "$HOME/.npmrc" ]; then
            cat "$HOME/.npmrc" | sed 's/\(_auth=\).*/\1***REDACTED***/'
          else
            echo "No .npmrc found"
          fi
      
      - name: Debug - Create tarball and inspect
        run: |
          echo "=== DEBUG: Creating tarball for inspection ==="
          npm pack --dry-run
          echo ""
          echo "=== DEBUG: Files that will be published ==="
          npm pack --dry-run 2>&1 | grep -E "npm notice|\.tgz" | head -30
          echo ""
          echo "=== DEBUG: Creating actual tarball ==="
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TARBALL="${PACKAGE_NAME}-${PACKAGE_VERSION}.tgz"
          npm pack
          echo ""
          echo "=== DEBUG: Tarball created: $TARBALL ==="
          ls -lh "$TARBALL"
          echo ""
          echo "=== DEBUG: Tarball contents ==="
          tar -tzf "$TARBALL" | head -20
          echo ""
          echo "=== DEBUG: package.json from tarball ==="
          tar -xzf "$TARBALL" package/package.json -O | head -50
      
      - name: Debug - Show environment variables
        run: |
          echo "=== DEBUG: Environment variables ==="
          echo "NODE_AUTH_TOKEN is set: $([ -n "$NODE_AUTH_TOKEN" ] && echo 'yes' || echo 'no')"
          echo "NPM_TOKEN is set: $([ -n "$NPM_TOKEN" ] && echo 'yes' || echo 'no')"
          echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"
          echo "GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "GITHUB_REF: $GITHUB_REF"
          echo "GITHUB_SHA: $GITHUB_SHA"
          echo ""
          echo "=== DEBUG: Working directory ==="
          pwd
          echo ""
          echo "=== DEBUG: Files in current directory ==="
          ls -la | head -20
      
      - name: Debug - Show what npm will publish (dry-run)
        run: |
          echo "=== DEBUG: npm publish dry-run ==="
          TAG="${{ inputs.tag || 'alpha' }}"
          npm publish --dry-run --access public --tag "$TAG" 2>&1 | tee publish-dryrun.log
          echo ""
          echo "=== DEBUG: Dry-run output saved to publish-dryrun.log ==="
      
      - name: Debug - Try to see npm's internal publish metadata (if possible)
        run: |
          echo "=== DEBUG: Attempting to inspect npm's publish metadata preparation ==="
          echo "This step tries to see what npm prepares before sending to registry"
          echo ""
          echo "=== DEBUG: npm pack output (shows what goes into tarball) ==="
          npm pack 2>&1 | head -30
          echo ""
          echo "=== DEBUG: Checking for any temporary files npm creates ==="
          find /tmp -name "*npm*" -o -name "*publish*" 2>/dev/null | head -10 || echo "No temp files found"
          echo ""
          echo "=== DEBUG: npm cache location contents ==="
          CACHE_DIR=$(npm config get cache)
          if [ -d "$CACHE_DIR" ]; then
            echo "Cache dir: $CACHE_DIR"
            ls -la "$CACHE_DIR" | head -10
          fi
          echo ""
          echo "=== DEBUG: Checking npm's internal state ==="
          npm config list --json 2>/dev/null | head -50 || npm config list | head -50
      
      - name: Publish to JFrog Artifactory
        run: |
          TAG="${{ inputs.tag || 'alpha' }}"
          echo "=== Publishing to JFrog Artifactory ==="
          echo "Tag: $TAG"
          echo "Note: Provenance is not supported by JFrog Artifactory, publishing without it"
          echo ""
          echo "=== DEBUG: Running npm publish with maximum logging ==="
          echo "This will show HTTP requests and responses"
          NPM_CONFIG_LOGLEVEL=silly npm publish --access public --tag "$TAG" 2>&1 | tee publish-output.log
          echo ""
          echo "=== DEBUG: Publish output saved to publish-output.log ==="
        env:
          NPM_CONFIG_LOGLEVEL: silly
          NODE_DEBUG: http,https
      
      - name: Debug - Show publish logs
        if: always()
        run: |
          echo "=== DEBUG: Publish output log (showing HTTP requests) ==="
          if [ -f publish-output.log ]; then
            echo "--- HTTP Requests/Responses ---"
            grep -E "(http fetch|PUT|GET|POST|Request|Response|status|headers)" publish-output.log | head -50 || echo "No HTTP details found"
            echo ""
            echo "--- Full publish output (last 200 lines) ---"
            tail -200 publish-output.log
          else
            echo "No publish-output.log found"
          fi
          echo ""
          echo "=== DEBUG: Dry-run log ==="
          if [ -f publish-dryrun.log ]; then
            cat publish-dryrun.log
          fi
          echo ""
          echo "=== DEBUG: npm debug logs location ==="
          find ~/.npm/_logs -name "*.log" -type f -mmin -5 2>/dev/null | head -5
          echo ""
          echo "=== DEBUG: Latest npm debug log (showing HTTP details) ==="
          LATEST_LOG=$(find ~/.npm/_logs -name "*.log" -type f -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | cut -d' ' -f2-)
          if [ -n "$LATEST_LOG" ] && [ -f "$LATEST_LOG" ]; then
            echo "Log file: $LATEST_LOG"
            echo "--- HTTP-related lines ---"
            grep -E "(http|PUT|GET|POST|Request|Response|status|headers|body)" "$LATEST_LOG" | head -100 || echo "No HTTP details in log"
            echo ""
            echo "--- Last 150 lines of log ---"
            tail -150 "$LATEST_LOG"
          else
            echo "No debug log found"
          fi
          echo ""
          echo "=== DEBUG: Tarball still exists? ==="
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TARBALL="${PACKAGE_NAME}-${PACKAGE_VERSION}.tgz"
          if [ -f "$TARBALL" ]; then
            echo "Tarball exists: $TARBALL"
            ls -lh "$TARBALL"
          else
            echo "Tarball not found: $TARBALL"
          fi
